<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Crowe HSY - DenetÃ§i Dashboard - OneDrive Entegrasyonu">
    <meta name="author" content="">
    <title>CROWE HSY - DenetÃ§i Panel - OneDrive</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f8f9fc;
        }
        
        .navbar {
            background-color: #4e73df;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }
        
        .navbar-brand {
            color: white !important;
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .navbar .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        
        .navbar .nav-link:hover {
            color: white !important;
        }
        
        .container-fluid {
            padding: 2rem;
        }
        
        .welcome-header {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        @media (min-width: 768px) {
            .welcome-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .session-timer-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(37, 99, 235, 0.1);
            border-radius: 12px;
            padding: 0.6rem 1.1rem;
            border: 1px solid rgba(37, 99, 235, 0.25);
            min-width: 200px;
            justify-content: center;
        }
        
        .session-timer-pill .timer-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #2563eb;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }
        
        .session-timer-pill .timer-display {
            font-family: 'JetBrains Mono', 'Fira Mono', 'SFMono-Regular', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: #0f172a;
        }
        
        .onedrive-container {
            background: white;
            border-radius: 10px;
            padding: 0;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            min-height: 600px;
        }
        
        .onedrive-header {
            background: #0078d4;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .onedrive-toolbar {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e3e3e3;
            background-color: #faf9f8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .onedrive-toolbar .toolbar-left {
            display: flex;
            gap: 0.5rem;
        }
        
        .onedrive-toolbar .toolbar-right {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .onedrive-toolbar .btn {
            font-size: 0.9rem;
            padding: 0.375rem 0.75rem;
        }
        
        .view-toggle {
            display: flex;
            border: 1px solid #d2d0ce;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .view-toggle button {
            padding: 0.375rem 0.75rem;
            border: none;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-toggle button:hover {
            background: #f3f2f1;
        }
        
        .view-toggle button.active {
            background: #0078d4;
            color: white;
        }
        
        .view-toggle button:not(:last-child) {
            border-right: 1px solid #d2d0ce;
        }
        
        .sort-select {
            border: 1px solid #d2d0ce;
            border-radius: 4px;
            padding: 0.375rem 2rem 0.375rem 0.75rem;
            background: white;
            cursor: pointer;
        }
        
        .file-list {
            padding: 1.5rem;
            margin: 0;
            display: grid;
            gap: 1rem;
        }
        
        .file-list.list-view {
            display: block;
            padding: 0;
        }
        
        .file-list.grid-view {
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        }
        
        .file-card {
            background: white;
            border: 1px solid #edebe9;
            border-radius: 4px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .file-card:hover {
            box-shadow: 0 1.6px 3.6px 0 rgba(0,0,0,.132), 0 0.3px 0.9px 0 rgba(0,0,0,.108);
            border-color: #0078d4;
        }
        
        .file-card-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        
        .file-card-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: #323130;
            margin-bottom: 0.25rem;
            word-break: break-word;
        }
        
        .file-card-meta {
            font-size: 0.75rem;
            color: #605e5c;
        }
        
        .file-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e3e3e3;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .file-item:hover {
            background-color: #f3f2f1;
        }
        
        .file-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
            width: 40px;
            text-align: center;
        }
        
        .file-icon.folder {
            color: #ffb900;
        }
        
        .file-icon.excel {
            color: #107c41;
        }
        
        .file-icon.word {
            color: #185abd;
        }
        
        .file-icon.pdf {
            color: #dc3545;
        }
        
        .file-icon.image {
            color: #6c757d;
        }
        
        .file-icon.powerpoint {
            color: #d24726;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            color: #323130;
            margin-bottom: 0.25rem;
        }
        
        .file-meta {
            font-size: 0.85rem;
            color: #605e5c;
        }
        
        .file-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .file-actions .btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.85rem;
        }
        
        .breadcrumb {
            background-color: white;
            padding: 1rem 1.5rem;
            margin-bottom: 0;
        }
        
        .onedrive-empty {
            text-align: center;
            padding: 3rem;
            color: #605e5c;
        }
        
        .onedrive-empty i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: #d2d0ce;
        }
        
        .login-prompt {
            text-align: center;
            padding: 3rem;
        }
        
        .login-prompt .btn {
            margin-top: 1rem;
            padding: 0.75rem 2rem;
            font-size: 1.1rem;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
        }
        
        .loading .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        #fileUploadInput {
            display: none;
        }
        
        .storage-info {
            padding: 1rem 1.5rem;
            background-color: #f8f9fa;
            border-top: 1px solid #e3e3e3;
        }
        
        .storage-bar {
            height: 8px;
            background-color: #e3e3e3;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .storage-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #0078d4, #00bcf2);
            transition: width 0.3s;
        }
        
        /* Dosya Ã–nizleme Modal */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            overflow: auto;
        }
        
        .preview-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-container {
            background: white;
            border-radius: 0;
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
            display: flex;
            flex-direction: column;
            box-shadow: none;
        }
        
        .preview-header {
            background: #0078d4;
            color: white;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 50px;
        }
        
        .preview-header h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 80%;
        }
        
        .preview-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .preview-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .preview-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .preview-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .preview-toolbar {
            padding: 0.75rem 1.5rem;
            border-top: 1px solid #e3e3e3;
            background: #f8f9fa;
            display: flex;
            gap: 0.75rem;
            min-height: 55px;
            align-items: center;
        }
        
        .preview-toolbar .btn {
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <a class="navbar-brand" href="#">
            <i class="fas fa-shield-alt"></i> CROWE HSY - DenetÃ§i Paneli
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="fas fa-user"></i> <span id="userName">DenetÃ§i</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="signOut()"><i class="fas fa-sign-out-alt"></i> Ã‡Ä±kÄ±ÅŸ</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Welcome Header -->
        <div class="welcome-header">
            <div>
                <h2><i class="fas fa-user-shield text-primary"></i> HoÅŸ Geldiniz, <span id="userNameDisplay">DenetÃ§i</span></h2>
                <p class="mb-0 text-muted">Microsoft OneDrive entegrasyonu ile denetim dosyalarÄ±nÄ±za eriÅŸin.</p>
            </div>
            <div class="session-timer-pill" id="sessionTimerContainer">
                <span class="timer-label"><i class="far fa-clock"></i> Oturum SÃ¼resi</span>
                <span class="timer-display" id="sessionTimerDisplay">00:00:00</span>
            </div>
        </div>

        <!-- OneDrive Container -->
        <div class="onedrive-container">
            <!-- OneDrive Header -->
            <div class="onedrive-header">
                <div>
                    <i class="fab fa-microsoft fa-lg"></i> <span id="oneDriveTitle">Microsoft OneDrive</span>
                </div>
                <div>
                    <button class="btn btn-sm btn-light" id="refreshBtn" onclick="loadFiles()" style="display: none;">
                        <i class="fas fa-sync-alt"></i> Yenile
                    </button>
                    <button class="btn btn-sm btn-danger" id="signOutBtn" onclick="signOutOneDrive()" style="display: none;">
                        <i class="fas fa-sign-out-alt"></i> OneDrive'dan Ã‡Ä±k
                    </button>
                </div>
            </div>

            <!-- Content Area -->
            <div id="contentArea">
                <!-- Login Prompt -->
                <div id="loginPrompt" class="login-prompt">
                    <i class="fab fa-microsoft" style="font-size: 5rem; color: #0078d4;"></i>
                    <h3 class="mt-3">Microsoft OneDrive'a BaÄŸlan</h3>
                    <p class="text-muted">Denetim dosyalarÄ±nÄ±za eriÅŸmek iÃ§in Microsoft hesabÄ±nÄ±zla giriÅŸ yapÄ±n.</p>
                    <button class="btn btn-primary btn-lg" onclick="signIn()">
                        <i class="fab fa-microsoft"></i> Microsoft ile GiriÅŸ Yap
                    </button>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> GÃ¼venli OAuth2 protokolÃ¼ kullanÄ±lmaktadÄ±r.
                        </small>
                    </div>
                </div>

                <!-- Loading -->
                <div id="loadingArea" class="loading" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">YÃ¼kleniyor...</span>
                    </div>
                    <p class="mt-3 text-muted">OneDrive dosyalarÄ± yÃ¼kleniyor...</p>
                </div>

                <!-- Files Area -->
                <div id="filesArea" style="display: none;">
                    <!-- Breadcrumb -->
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb" id="breadcrumb">
                            <li class="breadcrumb-item active">YÃ¼kleniyor...</li>
                        </ol>
                    </nav>

                    <!-- Toolbar -->
                    <div class="onedrive-toolbar">
                        <div class="toolbar-left">
                            <button class="btn btn-sm btn-primary" onclick="document.getElementById('fileUploadInput').click()">
                                <i class="fas fa-upload"></i> YÃ¼kle
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="createFolder()">
                                <i class="fas fa-folder-plus"></i> Yeni
                            </button>
                        </div>
                        <div class="toolbar-right">
                            <select class="sort-select" id="sortSelect" onchange="sortFiles(this.value)">
                                <option value="name">Ä°sme GÃ¶re</option>
                                <option value="modified">DeÄŸiÅŸtirilme Tarihine GÃ¶re</option>
                                <option value="size">Boyuta GÃ¶re</option>
                            </select>
                            <div class="view-toggle">
                                <button onclick="changeView('list')" id="listViewBtn" class="active">
                                    <i class="fas fa-list"></i>
                                </button>
                                <button onclick="changeView('grid')" id="gridViewBtn">
                                    <i class="fas fa-th-large"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- File List -->
                    <div class="file-list list-view" id="fileList">
                        <!-- Dosyalar JavaScript ile yÃ¼klenecek -->
                    </div>

                    <!-- Storage Info -->
                    <div class="storage-info">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Depolama AlanÄ±</small>
                            <small class="text-muted" id="storageText">HesaplanÄ±yor...</small>
                        </div>
                        <div class="storage-bar">
                            <div class="storage-bar-fill" id="storageBarFill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden File Upload Input -->
            <input type="file" id="fileUploadInput" multiple onchange="uploadFiles(this.files)">
        </div>
    </div>

    <!-- Dosya Ã–nizleme Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-container">
            <div class="preview-header">
                <h4 id="previewFileName">Dosya Ã–nizleme</h4>
                <button class="preview-close" onclick="closePreview()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="preview-content">
                <div class="preview-loading" id="previewLoading">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="sr-only">YÃ¼kleniyor...</span>
                    </div>
                    <p class="mt-3">Dosya yÃ¼kleniyor...</p>
                </div>
                <iframe id="previewIframe" class="preview-iframe" style="display: none;"></iframe>
            </div>
            <div class="preview-toolbar">
                <button class="btn btn-sm btn-warning" id="previewEditBtn" onclick="editCurrentFile()" style="display: none;">
                    <i class="fas fa-edit"></i> DÃ¼zenle (SharePoint)
                </button>
                <button class="btn btn-sm btn-success" id="previewDownloadBtn" onclick="downloadCurrentPreview()">
                    <i class="fas fa-download"></i> Ä°ndir
                </button>
                <button class="btn btn-sm btn-primary" id="previewOpenNewTabBtn" onclick="openCurrentPreviewNewTab()">
                    <i class="fas fa-external-link-alt"></i> Yeni Sekmede AÃ§
                </button>
                <button class="btn btn-sm btn-secondary" onclick="closePreview()">
                    <i class="fas fa-times"></i> Kapat
                </button>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- MSAL.js - Microsoft Authentication Library -->
    <script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>
    
    <script>
        // MSAL Configuration
        // NOT: GerÃ§ek OneDrive entegrasyonu iÃ§in Azure AD'de uygulama kayÄ±t gereklidir.
        // Åžu an demo modunda Ã§alÄ±ÅŸÄ±yor - gerÃ§ek Microsoft hesabÄ± gerekmez.
        
        // DEMO MODE: GerÃ§ek Azure AD uygulamasÄ± iÃ§in aÅŸaÄŸÄ±daki client ID'yi deÄŸiÅŸtirin
        const DEMO_MODE = false; // false = GerÃ§ek OneDrive kullanÄ±lÄ±yor
        const YOUR_CLIENT_ID = "c0addd41-6869-47b6-8329-c0387a406104"; // Azure Portal'dan alÄ±ndÄ±
        
        const msalConfig = {
            auth: {
                clientId: DEMO_MODE ? "00000000-0000-0000-0000-000000000000" : YOUR_CLIENT_ID,
                // Tenant-specific endpoint kullanÄ±lÄ±yor (sadece CROWE HSY organizasyonu)
                // Multi-tenant iÃ§in: "https://login.microsoftonline.com/common"
                authority: "https://login.microsoftonline.com/organizations",
                redirectUri: window.location.origin + window.location.pathname
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        const loginRequest = {
            // PaylaÅŸÄ±lanlar iÃ§in Files.Read.All kullanÄ±yoruz (daha az kÄ±sÄ±tlayÄ±cÄ±)
            // Not: BazÄ± organizasyonlarda yine admin consent gerektirebilir
            scopes: ["User.Read", "Files.Read.All", "Sites.Read.All"]
        };

        let msalInstance;
        let accessToken = null;
        let currentFolderId = "root";
        let currentPath = [];
        let isViewingShared = false; // PaylaÅŸÄ±lanlar gÃ¶rÃ¼nÃ¼mÃ¼ kontrolÃ¼
        let currentView = 'list'; // 'list' veya 'grid'
        let currentFiles = []; // Mevcut dosyalarÄ± sakla (sÄ±ralama iÃ§in)
        let currentPreviewUrl = ''; // Ã–nizlemedeki dosyanÄ±n URL'si
        let currentPreviewFile = {}; // Ã–nizlemedeki dosyanÄ±n bilgileri
        let currentDriveId = null; // PaylaÅŸÄ±lan drive iÃ§indeyken drive ID'yi sakla
        
        const AUDITOR_SESSIONS_KEY = 'auditorSessions';
        const DEFAULT_AUDITOR_PASSWORD = 'Crowe2022!';
        let sessionTimerInterval = null;
        let sessionStartTime = null;

        // KullanÄ±cÄ± bilgisi
        const auditorUser = localStorage.getItem('auditorUser') || 'DenetÃ§i';
        document.getElementById('userName').textContent = auditorUser;
        document.getElementById('userNameDisplay').textContent = auditorUser;

        function hasAuditorPasswordChanged(email) {
            return localStorage.getItem('auditorPasswordChanged_' + email.toLowerCase()) === 'true';
        }

        function getStoredAuditorPassword(email) {
            return localStorage.getItem('auditorPassword_' + email.toLowerCase());
        }

        function ensureAuditorPasswordChange(email) {
            if (!email || email === 'DenetÃ§i') {
                window.location.href = 'auditor-login.html';
                return;
            }
            const normalized = email.toLowerCase();
            const storedPassword = getStoredAuditorPassword(normalized);
            const changed = hasAuditorPasswordChanged(normalized);
            if (!changed || !storedPassword || storedPassword === DEFAULT_AUDITOR_PASSWORD) {
                localStorage.setItem('auditorPendingPasswordChange', normalized);
                window.location.href = 'auditor-password-change.html';
            }
        }

        ensureAuditorPasswordChange(auditorUser);

        function getAuditorSessionsStore() {
            const raw = localStorage.getItem(AUDITOR_SESSIONS_KEY);
            if (!raw) return {};
            try {
                const parsed = JSON.parse(raw);
                return parsed && typeof parsed === 'object' ? parsed : {};
            } catch (err) {
                console.warn('Auditor session store parse error:', err);
                return {};
            }
        }

        function setAuditorSessionsStore(store) {
            localStorage.setItem(AUDITOR_SESSIONS_KEY, JSON.stringify(store || {}));
        }

        function updateAuditorSessionStore(email, patch) {
            if (!email) {
                return;
            }
            const normalized = email.toLowerCase();
            const store = getAuditorSessionsStore();
            const existing = store[normalized] || {
                email: email,
                displayName: email,
                startTime: null,
                elapsed: 0,
                active: false,
                lastUpdate: null
            };
            store[normalized] = Object.assign({}, existing, patch || {}, {
                email: email,
                displayName: (patch && patch.displayName) || existing.displayName || email
            });
            setAuditorSessionsStore(store);
            // Storage event not triggered in same tab, manually dispatch custom event
            window.dispatchEvent(new CustomEvent('auditorSessionsUpdated'));
        }

        function formatDuration(ms) {
            if (!ms || Number.isNaN(ms) || ms < 0) {
                ms = 0;
            }
            const totalSeconds = Math.floor(ms / 1000);
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function updateSessionTimerDisplay(ms) {
            const el = document.getElementById('sessionTimerDisplay');
            if (!el) return;
            el.textContent = formatDuration(ms);
        }

        function startAuditorSessionTimer(email) {
            if (!email) return;
            const normalized = email.toLowerCase();
            const store = getAuditorSessionsStore();
            const existing = store[normalized];
            const now = Date.now();
            if (existing && existing.active && existing.startTime) {
                sessionStartTime = existing.startTime;
            } else {
                sessionStartTime = now;
            }

            updateSessionTimerDisplay(now - sessionStartTime);
            updateAuditorSessionStore(email, {
                displayName: email,
                startTime: sessionStartTime,
                lastUpdate: now,
                elapsed: now - sessionStartTime,
                active: true
            });

            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
            }

            sessionTimerInterval = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                updateSessionTimerDisplay(elapsed);
                updateAuditorSessionStore(email, {
                    lastUpdate: Date.now(),
                    elapsed: elapsed,
                    active: true
                });
            }, 1000);
        }

        function stopAuditorSessionTimer(email) {
            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
                sessionTimerInterval = null;
            }
            if (!email) return;
            const now = Date.now();
            const elapsed = sessionStartTime ? (now - sessionStartTime) : 0;
            sessionStartTime = null;
            updateSessionTimerDisplay(0);
            updateAuditorSessionStore(email, {
                lastUpdate: now,
                elapsed: elapsed,
                active: false,
                endTime: now
            });
        }

        function restoreAuditorSessionTimer(email) {
            if (!email) {
                updateSessionTimerDisplay(0);
                return;
            }
            const normalized = email.toLowerCase();
            const store = getAuditorSessionsStore();
            const existing = store[normalized];
            if (existing && existing.active && existing.startTime) {
                sessionStartTime = existing.startTime;
                if (sessionTimerInterval) {
                    clearInterval(sessionTimerInterval);
                }
                updateSessionTimerDisplay(Date.now() - sessionStartTime);
                sessionTimerInterval = setInterval(() => {
                    const elapsed = Date.now() - sessionStartTime;
                    updateSessionTimerDisplay(elapsed);
                    updateAuditorSessionStore(email, {
                        lastUpdate: Date.now(),
                        elapsed: elapsed,
                        active: true
                    });
                }, 1000);
            } else if (existing && existing.elapsed) {
                updateSessionTimerDisplay(existing.elapsed);
            } else {
                updateSessionTimerDisplay(0);
            }
        }

        restoreAuditorSessionTimer(auditorUser);

        window.addEventListener('beforeunload', function() {
            if (!auditorUser) return;
            const now = Date.now();
            if (sessionStartTime !== null) {
                const elapsed = now - sessionStartTime;
                updateAuditorSessionStore(auditorUser, {
                    lastUpdate: now,
                    elapsed: elapsed,
                    active: false,
                    endTime: now
                });
            }
        });

        // MSAL Instance oluÅŸtur (sadece gerÃ§ek Azure AD kullanÄ±yorsak)
        if (!DEMO_MODE) {
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                
                // Redirect response'Ä± handle et (kritik!)
                msalInstance.handleRedirectPromise()
                    .then(response => {
                        if (response) {
                            console.log("âœ… Redirect sonrasÄ± geri dÃ¶nÃ¼ldÃ¼:", response.account.username);
                            msalInstance.setActiveAccount(response.account);
                            accessToken = response.accessToken;
                            
                            // BaÅŸarÄ±lÄ± giriÅŸ sonrasÄ± OneDrive'Ä± gÃ¶ster
                            document.getElementById('oneDriveTitle').textContent = 
                                'Microsoft OneDrive - ' + response.account.name;
                            
                            showFilesArea();
                            loadFiles();
                            startAuditorSessionTimer(auditorUser);
                        }
                    })
                    .catch(error => {
                        console.error("Redirect handling error:", error);
                        showError("GiriÅŸ sonrasÄ± hata: " + error.message);
                    });
            } catch (error) {
                console.error("MSAL baÅŸlatÄ±lamadÄ±:", error);
                showError("Microsoft Authentication Library yÃ¼klenemedi. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
            }
        }

        // Sayfa yÃ¼klendiÄŸinde token kontrolÃ¼
        $(document).ready(async function() {
            // Ä°lk olarak mevcut interaction'larÄ± temizle
            if (!DEMO_MODE && msalInstance) {
                try {
                    // Mevcut interaction'Ä± bekle ve temizle
                    await msalInstance.handleRedirectPromise();
                } catch (error) {
                    console.log("Redirect promise error (normal):", error);
                }
            }
            
            checkAuthState();
        });

        async function checkAuthState() {
            // Demo mode: Login ekranÄ±nÄ± gÃ¶ster
            if (DEMO_MODE) {
                showLoginPrompt();
                return;
            }
            
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                msalInstance.setActiveAccount(accounts[0]);
                try {
                    await getTokenSilent();
                    showFilesArea();
                    loadFiles();
                    startAuditorSessionTimer(auditorUser);
                } catch (error) {
                    console.error("Token alÄ±namadÄ±:", error);
                    showLoginPrompt();
                }
            } else {
                showLoginPrompt();
            }
        }

        let isSigningIn = false; // Ã‡ift tÄ±klama engeli

        // MSAL interaction flag'ini temizle
        function clearInteractionInProgress() {
            // LocalStorage'daki tÃ¼m interaction flag'lerini temizle
            Object.keys(localStorage).forEach(key => {
                if (key.includes('interaction.status') || 
                    key.includes('interaction_status') ||
                    key.includes('.interaction.')) {
                    localStorage.removeItem(key);
                    console.log('Temizlendi:', key);
                }
            });
        }

        async function signIn() {
            // EÄŸer zaten giriÅŸ iÅŸlemi devam ediyorsa, tekrar baÅŸlatma
            if (isSigningIn) {
                console.log("GiriÅŸ iÅŸlemi zaten devam ediyor, lÃ¼tfen bekleyin...");
                return;
            }

            // DEMO MODE kontrolÃ¼
            if (DEMO_MODE) {
                showLoading();
                setTimeout(() => {
                    document.getElementById('oneDriveTitle').textContent = 
                        'Microsoft OneDrive - ' + auditorUser + ' (Demo Mode)';
                    accessToken = 'DEMO_TOKEN';
                    showFilesArea();
                    loadDemoFiles();
                }, 1000);
                return;
            }
            
            // Ã–nce interaction flag'lerini temizle
            clearInteractionInProgress();
            
            isSigningIn = true;
            
            try {
                showLoading();
                
                // Mevcut hesaplarÄ± kontrol et
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    msalInstance.setActiveAccount(accounts[0]);
                    console.log('Mevcut hesap bulundu:', accounts[0].username);
                }
                
                console.log('LoginRedirect baÅŸlatÄ±lÄ±yor...');
                // Popup yerine redirect kullan (daha gÃ¼venilir)
                await msalInstance.loginRedirect(loginRequest);
                
                // Redirect sonrasÄ± sayfa yeniden yÃ¼klenecek, bu kod Ã§alÄ±ÅŸmaz
                // handleRedirectPromise bu iÅŸi yapacak
            } catch (error) {
                console.error("GiriÅŸ hatasÄ±:", error);
                
                // Interaction in progress hatasÄ± iÃ§in Ã¶zel iÅŸlem
                if (error.errorCode === 'interaction_in_progress' || 
                    error.message.includes('interaction_in_progress')) {
                    
                    console.warn('Interaction flag temizleniyor ve tekrar deneniyor...');
                    clearInteractionInProgress();
                    isSigningIn = false;
                    
                    showError("Ã–nceki giriÅŸ iÅŸlemi temizlendi. LÃ¼tfen tekrar 'GiriÅŸ Yap' butonuna tÄ±klayÄ±n.");
                    showLoginPrompt();
                } else {
                    showError("Microsoft hesabÄ±na giriÅŸ yapÄ±lamadÄ±: " + (error.errorMessage || error.message));
                    showLoginPrompt();
                }
            } finally {
                isSigningIn = false;
            }
        }

        async function getTokenSilent() {
            const account = msalInstance.getActiveAccount();
            if (!account) {
                throw new Error("No active account");
            }

            const silentRequest = {
                scopes: loginRequest.scopes,
                account: account
            };

            try {
                const response = await msalInstance.acquireTokenSilent(silentRequest);
                accessToken = response.accessToken;
                document.getElementById('oneDriveTitle').textContent = 
                    'Microsoft OneDrive - ' + response.account.name;
                return accessToken;
            } catch (error) {
                if (error instanceof msal.InteractionRequiredAuthError) {
                    return await msalInstance.acquireTokenPopup(silentRequest);
                }
                throw error;
            }
        }

        async function signOutOneDrive() {
            if (DEMO_MODE) {
                accessToken = null;
                stopAuditorSessionTimer(auditorUser);
                showLoginPrompt();
                return;
            }
            
            const account = msalInstance.getActiveAccount();
            if (account) {
                // Popup yerine redirect kullan
                await msalInstance.logoutRedirect({
                    account: account
                });
            }
            accessToken = null;
            stopAuditorSessionTimer(auditorUser);
            showLoginPrompt();
        }

        function signOut() {
            signOutOneDrive();
            localStorage.removeItem('auditorUser');
            localStorage.removeItem('auditorPendingPasswordChange');
            window.location.href = 'auditor-login.html';
        }

        async function loadSharedFiles() {
            if (!accessToken) {
                try {
                    await getTokenSilent();
                } catch (error) {
                    console.error("Token alÄ±namadÄ±:", error);
                    showError("Token alÄ±namadÄ±. LÃ¼tfen tekrar giriÅŸ yapÄ±n.");
                    showLoginPrompt();
                    return;
                }
            }

            showLoading();
            isViewingShared = true;
            currentFolderId = "shared";
            currentPath = []; // Yolu sÄ±fÄ±rla
            currentDriveId = null; // Drive ID'yi sÄ±fÄ±rla

            try {
                const endpoint = "https://graph.microsoft.com/v1.0/me/drive/sharedWithMe?$top=999";
                console.log("PaylaÅŸÄ±lan dosyalar yÃ¼kleniyor:", endpoint);
                
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                console.log("API yanÄ±t durumu:", response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("API HatasÄ±:", errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }

                const data = await response.json();
                console.log("âœ… PaylaÅŸÄ±lan dosya sayÄ±sÄ±:", data.value ? data.value.length : 0);
                
                // Debug: Ä°lk dosyanÄ±n yapÄ±sÄ±nÄ± gÃ¶ster
                if (data.value && data.value.length > 0) {
                    console.log("ðŸ” Ä°lk paylaÅŸÄ±lan dosya yapÄ±sÄ±:", data.value[0]);
                    console.log("ðŸ” remoteItem var mÄ±?", data.value[0].remoteItem !== undefined);
                    console.log("ðŸ” webUrl:", data.value[0].webUrl);
                    if (data.value[0].remoteItem) {
                        console.log("ðŸ” remoteItem.id:", data.value[0].remoteItem.id);
                        console.log("ðŸ” remoteItem.driveId:", data.value[0].remoteItem.parentReference?.driveId);
                    }
                }
                
                displayFiles(data.value || []);
                loadStorageInfo();
                showFilesArea();
            } catch (error) {
                console.error("PaylaÅŸÄ±lan dosyalar yÃ¼kleme hatasÄ±:", error);
                alert("PaylaÅŸÄ±lan dosyalar yÃ¼klenirken hata oluÅŸtu: " + error.message);
                // Ana klasÃ¶re geri dÃ¶n ama oturumu kapatma
                loadFiles('root');
            }
        }

        async function loadFiles(folderId = "root") {
            if (DEMO_MODE) {
                loadDemoFiles();
                return;
            }
            
            if (!accessToken) {
                try {
                    await getTokenSilent();
                } catch (error) {
                    console.error("Token alÄ±namadÄ±:", error);
                    showError("Token alÄ±namadÄ±. LÃ¼tfen tekrar giriÅŸ yapÄ±n.");
                    showLoginPrompt();
                    return;
                }
            }

            showLoading();
            isViewingShared = false;
            currentFolderId = folderId;
            currentPath = []; // Normal klasÃ¶rlerde yolu sÄ±fÄ±rla
            currentDriveId = null; // Kendi drive'Ä±mÄ±za dÃ¶ndÃ¼k

            try {
                // OneDrive API Ã§aÄŸrÄ±sÄ± - $top=999 ile daha fazla dosya iste
                const endpoint = folderId === "root" 
                    ? "https://graph.microsoft.com/v1.0/me/drive/root/children?$top=999&$orderby=name"
                    : `https://graph.microsoft.com/v1.0/me/drive/items/${folderId}/children?$top=999&$orderby=name`;

                console.log("OneDrive API isteÄŸi gÃ¶nderiliyor:", endpoint);
                
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                console.log("API yanÄ±t durumu:", response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("API HatasÄ±:", errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }

                const data = await response.json();
                console.log("YÃ¼klenen dosya sayÄ±sÄ±:", data.value ? data.value.length : 0);
                
                let allFiles = data.value || [];
                
                // EÄŸer daha fazla dosya varsa (@odata.nextLink), onlarÄ± da yÃ¼kle
                let nextLink = data['@odata.nextLink'];
                while (nextLink) {
                    console.log("Daha fazla dosya yÃ¼kleniyor...", nextLink);
                    const nextResponse = await fetch(nextLink, {
                        headers: {
                            'Authorization': 'Bearer ' + accessToken
                        }
                    });
                    
                    if (nextResponse.ok) {
                        const nextData = await nextResponse.json();
                        allFiles = allFiles.concat(nextData.value || []);
                        nextLink = nextData['@odata.nextLink'];
                        console.log("Toplam dosya sayÄ±sÄ±:", allFiles.length);
                    } else {
                        break;
                    }
                }
                
                console.log("âœ… Toplam yÃ¼klenen dosya:", allFiles.length);
                displayFiles(allFiles);
                
                // Storage bilgisini al
                loadStorageInfo();

                showFilesArea();
            } catch (error) {
                console.error("Dosya yÃ¼kleme hatasÄ±:", error);
                
                // 401 veya 403 hatasÄ± ise token geÃ§ersiz, yeniden giriÅŸ gerekli
                if (error.message.includes('401') || error.message.includes('403')) {
                    alert("Oturum sÃ¼resi doldu. LÃ¼tfen tekrar giriÅŸ yapÄ±n.");
                    showLoginPrompt();
                } else {
                    // DiÄŸer hatalar iÃ§in oturumu kapatma
                    alert("Dosyalar yÃ¼klenirken hata oluÅŸtu: " + error.message);
                }
            }
        }

        function loadDemoSharedFiles() {
            isViewingShared = true;
            currentFolderId = "shared";
            
            const demoSharedFiles = [
                { name: 'Ortak-Proje-2024.xlsx', folder: false, size: 1200000, lastModified: '2024-11-05', id: 'demo-shared-1' },
                { name: 'PaylaÅŸÄ±lan-Sunum.pptx', folder: false, size: 3500000, lastModified: '2024-11-04', id: 'demo-shared-2' },
                { name: 'Ekip-NotlarÄ±.docx', folder: false, size: 450000, lastModified: '2024-11-03', id: 'demo-shared-3' }
            ];

            const files = demoSharedFiles.map(f => ({
                id: f.id,
                name: f.name,
                folder: f.folder ? { childCount: f.childCount } : undefined,
                size: f.size,
                lastModifiedDateTime: f.lastModified
            }));

            displayFiles(files);
            document.getElementById('storageText').textContent = '8.5 GB / 15 GB kullanÄ±ldÄ± (56.7%)';
            document.getElementById('storageBarFill').style.width = '56.7%';
            showFilesArea();
        }

        function loadDemoFiles() {
            isViewingShared = false;
            currentFolderId = "root";
            
            const demoFiles = [
                { name: 'Denetim RaporlarÄ± 2024', folder: true, childCount: 24, lastModified: '2024-11-05', id: 'demo-folder-1' },
                { name: 'Mali Tablolar', folder: true, childCount: 15, lastModified: '2024-11-04', id: 'demo-folder-2' },
                { name: 'Belgeler', folder: true, childCount: 8, lastModified: '2024-11-03', id: 'demo-folder-3' },
                { name: 'Q3-2024-Denetim-Raporu.xlsx', folder: false, size: 2400000, lastModified: '2024-11-06', id: 'demo-file-1' },
                { name: 'Mali-Analiz-Raporu.docx', folder: false, size: 1800000, lastModified: '2024-11-05', id: 'demo-file-2' },
                { name: 'Finansal-Ozet.pdf', folder: false, size: 856000, lastModified: '2024-11-04', id: 'demo-file-3' },
                { name: 'Yillik-Rapor-2024.pdf', folder: false, size: 3200000, lastModified: '2024-11-03', id: 'demo-file-4' }
            ];

            const files = demoFiles.map(f => ({
                id: f.id,
                name: f.name,
                folder: f.folder ? { childCount: f.childCount } : undefined,
                size: f.size,
                lastModifiedDateTime: f.lastModified
            }));

            displayFiles(files);
            
            // Demo storage info
            document.getElementById('storageText').textContent = '8.5 GB / 15 GB kullanÄ±ldÄ± (56.7%)';
            document.getElementById('storageBarFill').style.width = '56.7%';
        }

        async function loadStorageInfo() {
            if (DEMO_MODE) {
                return; // Demo mode'da loadDemoFiles zaten storage bilgisini yÃ¼klÃ¼yor
            }
            
            try {
                const response = await fetch("https://graph.microsoft.com/v1.0/me/drive", {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const quota = data.quota;
                    const used = quota.used;
                    const total = quota.total;
                    const percentage = (used / total * 100).toFixed(1);

                    document.getElementById('storageText').textContent = 
                        `${formatBytes(used)} / ${formatBytes(total)} kullanÄ±ldÄ± (${percentage}%)`;
                    document.getElementById('storageBarFill').style.width = percentage + '%';
                }
            } catch (error) {
                console.error("Storage bilgisi alÄ±namadÄ±:", error);
            }
        }

        function changeView(viewType) {
            currentView = viewType;
            const fileListContainer = document.getElementById('fileList');
            
            // Buton aktif durumlarÄ±nÄ± gÃ¼ncelle
            document.getElementById('listViewBtn').classList.toggle('active', viewType === 'list');
            document.getElementById('gridViewBtn').classList.toggle('active', viewType === 'grid');
            
            // View class'Ä±nÄ± gÃ¼ncelle
            fileListContainer.className = `file-list ${viewType}-view`;
            
            // DosyalarÄ± yeniden render et
            displayFiles(currentFiles);
        }
        
        function sortFiles(sortBy) {
            if (currentFiles.length === 0) return;
            
            const sorted = [...currentFiles].sort((a, b) => {
                if (sortBy === 'name') {
                    return a.name.localeCompare(b.name, 'tr');
                } else if (sortBy === 'modified') {
                    return new Date(b.lastModifiedDateTime) - new Date(a.lastModifiedDateTime);
                } else if (sortBy === 'size') {
                    const sizeA = a.size || 0;
                    const sizeB = b.size || 0;
                    return sizeB - sizeA;
                }
                return 0;
            });
            
            currentFiles = sorted;
            displayFiles(sorted);
        }

        function displayFiles(files) {
            const fileListContainer = document.getElementById('fileList');
            currentFiles = files; // DosyalarÄ± sakla
            
            if (files.length === 0 && currentFolderId === "shared") {
                fileListContainer.innerHTML = `
                    <div class="onedrive-empty">
                        <i class="fas fa-share-alt"></i>
                        <h5>PaylaÅŸÄ±lan Dosya Yok</h5>
                        <p class="text-muted">Sizinle paylaÅŸÄ±lan dosya bulunmuyor.</p>
                    </div>
                `;
                return;
            }
            
            if (files.length === 0) {
                fileListContainer.innerHTML = `
                    <div class="onedrive-empty">
                        <i class="fas fa-folder-open"></i>
                        <h5>Bu klasÃ¶r boÅŸ</h5>
                        <p class="text-muted">Dosya yÃ¼klemek iÃ§in "YÃ¼kle" butonuna tÄ±klayÄ±n.</p>
                    </div>
                `;
                return;
            }

            let html = '';

            // Root klasÃ¶rdeyse, en Ã¼stte "PaylaÅŸÄ±lanlar" sanal klasÃ¶rÃ¼nÃ¼ ekle
            if (currentFolderId === "root" && !isViewingShared) {
                const loadFunc = DEMO_MODE ? 'loadDemoSharedFiles()' : 'loadSharedFiles()';
                html += `
                    <div class="file-item" onclick="${loadFunc}" style="background-color: #f0f8ff;">
                        <i class="fas fa-share-alt file-icon" style="color: #0078d4;"></i>
                        <div class="file-info">
                            <div class="file-name">ðŸ“¤ PaylaÅŸÄ±lanlar</div>
                            <div class="file-meta">Benimle paylaÅŸÄ±lan dosyalar</div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); ${loadFunc}">
                                <i class="fas fa-folder-open"></i> AÃ§
                            </button>
                        </div>
                    </div>
                `;
            }

            files.forEach(file => {
                // PaylaÅŸÄ±lan dosyalar iÃ§in remoteItem kullan
                const isSharedItem = file.remoteItem !== undefined;
                
                // Shared item ise remoteItem'dan bilgileri al
                const fileData = isSharedItem ? file.remoteItem : file;
                const isFolder = fileData.folder !== undefined;
                const iconHTML = getFileIconFromName(file.name, isFolder);
                const size = isFolder ? (fileData.folder?.childCount + ' Ã¶ÄŸe' || 'KlasÃ¶r') : formatBytes(fileData.size || file.size || 0);
                const modified = new Date(file.lastModifiedDateTime).toLocaleDateString('tr-TR');
                
                // ID ve Drive bilgilerini al
                const actualId = isSharedItem ? fileData.id : file.id;
                
                // Drive ID'yi belirle: 
                // 1. Shared item ise remoteItem'dan al
                // 2. PaylaÅŸÄ±lan drive iÃ§indeysek (currentDriveId varsa) onu kullan
                // 3. DeÄŸilse boÅŸ bÄ±rak (kendi drive'Ä±mÄ±z)
                let driveId = '';
                if (isSharedItem) {
                    driveId = fileData.parentReference?.driveId || '';
                } else if (currentDriveId) {
                    driveId = currentDriveId; // PaylaÅŸÄ±lan drive iÃ§indeyiz
                }
                
                const webUrl = file.webUrl || fileData.webUrl || '';
                
                // Debug log (ilk dosya iÃ§in)
                if (files.indexOf(file) === 0) {
                    console.log("ðŸ” Dosya render:", {
                        name: file.name,
                        isSharedItem,
                        isFolder,
                        actualId,
                        driveId,
                        currentDriveId,
                        webUrl: webUrl ? webUrl.substring(0, 50) + '...' : 'yok'
                    });
                }
                
                // PaylaÅŸÄ±lan drive iÃ§inde miyiz?
                const isInSharedDrive = (currentDriveId !== null);
                
                // GÃ¼venli string dÃ¶nÃ¼ÅŸÃ¼mÃ¼ (onclick iÃ§in)
                const safeWebUrl = webUrl ? webUrl.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';
                const safeDriveId = driveId || '';
                const safeActualId = actualId || '';

                if (currentView === 'grid') {
                    // Kart gÃ¶rÃ¼nÃ¼mÃ¼
                    let clickAction;
                    if (isFolder) {
                        // KlasÃ¶r: PaylaÅŸÄ±lan drive iÃ§indeysek veya shared item ise openSharedFolder kullan
                        if (isInSharedDrive || isSharedItem) {
                            clickAction = `loadSharedFolderContent('${safeDriveId}', '${safeActualId}', '${escapeHtml(file.name)}')`;
                        } else {
                            clickAction = `loadFiles('${safeActualId}')`;
                        }
                    } else {
                        // Dosya: PaylaÅŸÄ±lan drive iÃ§indeysek veya shared item ise openSharedFile kullan
                        if (isInSharedDrive || isSharedItem) {
                            clickAction = `openSharedFile('${safeDriveId}', '${safeActualId}', '${escapeHtml(file.name)}', '${safeWebUrl}')`;
                        } else {
                            clickAction = `openFile('${safeActualId}', '${escapeHtml(file.name)}')`;
                        }
                    }
                    
                    html += `
                        <div class="file-card" onclick="${clickAction}">
                            <div class="file-card-icon">${iconHTML}</div>
                            <div class="file-card-name" title="${escapeHtml(file.name)}">${escapeHtml(file.name)}</div>
                            <div class="file-card-meta">${size}</div>
                        </div>
                    `;
                } else {
                    // Liste gÃ¶rÃ¼nÃ¼mÃ¼
                    let clickAction;
                    if (isFolder) {
                        // KlasÃ¶r: PaylaÅŸÄ±lan drive iÃ§indeysek veya shared item ise openSharedFolder kullan
                        if (isInSharedDrive || isSharedItem) {
                            clickAction = `loadSharedFolderContent('${safeDriveId}', '${safeActualId}', '${escapeHtml(file.name)}')`;
                        } else {
                            clickAction = `loadFiles('${safeActualId}')`;
                        }
                    } else {
                        // Dosya: PaylaÅŸÄ±lan drive iÃ§indeysek veya shared item ise openSharedFile kullan
                        if (isInSharedDrive || isSharedItem) {
                            clickAction = `openSharedFile('${safeDriveId}', '${safeActualId}', '${escapeHtml(file.name)}', '${safeWebUrl}')`;
                        } else {
                            clickAction = `openFile('${safeActualId}', '${escapeHtml(file.name)}')`;
                        }
                    }
                    
                    html += `
                        <div class="file-item" onclick="${clickAction}">
                            ${iconHTML}
                            <div class="file-info">
                                <div class="file-name">${escapeHtml(file.name)}${isSharedItem ? ' <span style="color: #0078d4; font-size: 0.75rem;"><i class="fas fa-share-alt"></i></span>' : ''}</div>
                                <div class="file-meta">${size} â€¢ ${modified}</div>
                            </div>
                            <div class="file-actions">
                                ${!isFolder ? `
                                <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); ${(isInSharedDrive || isSharedItem) ? `downloadSharedFile('${safeDriveId}', '${safeActualId}', '${escapeHtml(file.name)}')` : `downloadFile('${safeActualId}', '${escapeHtml(file.name)}')`}">
                                    <i class="fas fa-download"></i>
                                </button>
                                ` : ''}
                                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); ${safeWebUrl ? `window.open('${safeWebUrl}', '_blank')` : `shareFile('${safeActualId}')`}">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }
            });

            fileListContainer.innerHTML = html;
            updateBreadcrumb();
        }

        function getFileIconFromName(name, isFolder) {
            if (isFolder) {
                return '<i class="fas fa-folder file-icon folder"></i>';
            }

            const ext = name.split('.').pop().toLowerCase();
            const icons = {
                'xlsx': '<i class="fas fa-file-excel file-icon excel"></i>',
                'xls': '<i class="fas fa-file-excel file-icon excel"></i>',
                'docx': '<i class="fas fa-file-word file-icon word"></i>',
                'doc': '<i class="fas fa-file-word file-icon word"></i>',
                'pdf': '<i class="fas fa-file-pdf file-icon pdf"></i>',
                'pptx': '<i class="fas fa-file-powerpoint file-icon powerpoint"></i>',
                'ppt': '<i class="fas fa-file-powerpoint file-icon powerpoint"></i>',
                'png': '<i class="fas fa-file-image file-icon image"></i>',
                'jpg': '<i class="fas fa-file-image file-icon image"></i>',
                'jpeg': '<i class="fas fa-file-image file-icon image"></i>',
                'gif': '<i class="fas fa-file-image file-icon image"></i>'
            };

            return icons[ext] || '<i class="fas fa-file file-icon"></i>';
        }

        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            
            if (isViewingShared) {
                breadcrumb.innerHTML = `
                    <li class="breadcrumb-item">
                        <a href="#" onclick="loadFiles('root'); return false;">
                            <i class="fas fa-home"></i> Ana KlasÃ¶r
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="#" onclick="loadSharedFiles(); return false;">
                            <i class="fas fa-share-alt"></i> PaylaÅŸÄ±lanlar
                        </a>
                    </li>
                `;
                
                // PaylaÅŸÄ±lan klasÃ¶r yolunu gÃ¶ster
                if (currentPath.length > 0) {
                    currentPath.forEach((folder, index) => {
                        if (index < currentPath.length - 1) {
                            breadcrumb.innerHTML += `
                                <li class="breadcrumb-item">
                                    <a href="#" onclick="loadSharedFolderContent('${folder.driveId}', '${folder.id}', '${escapeHtml(folder.name)}'); return false;">
                                        ${escapeHtml(folder.name)}
                                    </a>
                                </li>
                            `;
                        } else {
                            breadcrumb.innerHTML += `
                                <li class="breadcrumb-item active" aria-current="page">
                                    ${escapeHtml(folder.name)}
                                </li>
                            `;
                        }
                    });
                }
            } else {
                breadcrumb.innerHTML = `
                    <li class="breadcrumb-item">
                        <a href="#" onclick="loadFiles('root'); return false;">
                            <i class="fas fa-home"></i> Ana KlasÃ¶r
                        </a>
                    </li>
                `;
                
                if (currentFolderId !== "root") {
                    breadcrumb.innerHTML += `
                        <li class="breadcrumb-item active" aria-current="page">KlasÃ¶r</li>
                    `;
                }
            }
        }

        async function downloadFile(fileId, fileName) {
            if (DEMO_MODE) {
                alert(`Demo Mode: "${fileName}" dosyasÄ± indiriliyor...\n\nGerÃ§ek OneDrive entegrasyonunda bu dosya indirilecektir.`);
                return;
            }
            
            try {
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/content`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (!response.ok) {
                    throw new Error("Dosya indirilemedi");
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showSuccess("Dosya baÅŸarÄ±yla indirildi: " + fileName);
            } catch (error) {
                console.error("Dosya indirme hatasÄ±:", error);
                showError("Dosya indirilemedi: " + error.message);
            }
        }

        async function openSharedFolder(driveId, itemId, folderName, webUrl) {
            console.log("ðŸ“ openSharedFolder Ã§aÄŸrÄ±ldÄ±:", {driveId, itemId, folderName});
            
            // PaylaÅŸÄ±lan klasÃ¶rÃ¼n iÃ§eriÄŸini yÃ¼kle (aynÄ± arayÃ¼zde)
            if (driveId && driveId !== 'null' && itemId && itemId !== 'null') {
                loadSharedFolderContent(driveId, itemId, folderName);
            } else {
                alert(`KlasÃ¶r bilgileri eksik.`);
            }
        }
        
        async function loadSharedFolderContent(driveId, itemId, folderName) {
            if (!accessToken) {
                try {
                    await getTokenSilent();
                } catch (error) {
                    console.error("Token alÄ±namadÄ±:", error);
                    alert("Token alÄ±namadÄ±. LÃ¼tfen tekrar giriÅŸ yapÄ±n.");
                    return;
                }
            }

            showLoading();
            isViewingShared = true;
            currentFolderId = itemId;
            currentDriveId = driveId; // Drive ID'yi sakla (alt klasÃ¶rler iÃ§in)

            try {
                const endpoint = `https://graph.microsoft.com/v1.0/drives/${driveId}/items/${itemId}/children?$top=999&$orderby=name`;
                console.log("ðŸ“ PaylaÅŸÄ±lan klasÃ¶r iÃ§eriÄŸi yÃ¼kleniyor:", endpoint);
                
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                console.log("API yanÄ±t durumu:", response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("API HatasÄ±:", errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log("âœ… KlasÃ¶r iÃ§eriÄŸi yÃ¼klendi:", data.value ? data.value.length : 0, "Ã¶ÄŸe");
                
                // Breadcrumb'a klasÃ¶r adÄ±nÄ± ekle (eÄŸer yoksa)
                const alreadyInPath = currentPath.find(p => p.id === itemId);
                if (!alreadyInPath) {
                    currentPath.push({name: folderName, id: itemId, driveId: driveId});
                }
                
                let allFiles = data.value || [];
                
                // Pagination
                let nextLink = data['@odata.nextLink'];
                while (nextLink) {
                    const nextResponse = await fetch(nextLink, {
                        headers: {
                            'Authorization': 'Bearer ' + accessToken
                        }
                    });
                    
                    if (nextResponse.ok) {
                        const nextData = await nextResponse.json();
                        allFiles = allFiles.concat(nextData.value || []);
                        nextLink = nextData['@odata.nextLink'];
                    } else {
                        break;
                    }
                }
                
                console.log("âœ… Toplam yÃ¼klenen Ã¶ÄŸe:", allFiles.length);
                displayFiles(allFiles);
                loadStorageInfo();
                showFilesArea();
            } catch (error) {
                console.error("PaylaÅŸÄ±lan klasÃ¶r yÃ¼kleme hatasÄ±:", error);
                alert("KlasÃ¶r iÃ§eriÄŸi yÃ¼klenirken hata oluÅŸtu: " + error.message);
                loadSharedFiles();
            }
        }

        async function openSharedFile(driveId, itemId, fileName, webUrl) {
            console.log("ðŸ“‚ openSharedFile Ã§aÄŸrÄ±ldÄ±:", {driveId, itemId, fileName, webUrl});
            
            // Her zaman API'den dosya bilgilerini al
            if (driveId && driveId !== 'null' && itemId && itemId !== 'null') {
                try {
                    console.log("ðŸ“¡ API isteÄŸi (dosya bilgileri iÃ§in): drives/" + driveId + "/items/" + itemId);
                    const response = await fetch(`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${itemId}`, {
                        headers: {
                            'Authorization': 'Bearer ' + accessToken
                        }
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error("âŒ API HatasÄ±:", errorText);
                        throw new Error("PaylaÅŸÄ±lan dosya bilgisi alÄ±namadÄ±: " + response.status);
                    }

                    const data = await response.json();
                    
                    // Ã–ncelik sÄ±rasÄ±: downloadUrl > webUrl (CSP bypass iÃ§in)
                    const fileUrlToUse = data['@microsoft.graph.downloadUrl'] || data.webUrl || webUrl;
                    
                    console.log("âœ… PaylaÅŸÄ±lan dosya URL'si alÄ±ndÄ±:", {
                        downloadUrl: data['@microsoft.graph.downloadUrl'] ? 'var' : 'yok',
                        webUrl: data.webUrl ? 'var' : 'yok',
                        using: fileUrlToUse.substring(0, 50) + '...'
                    });
                    
                    if (fileUrlToUse) {
                        openPreview(fileName, fileUrlToUse, {
                            driveId, 
                            itemId, 
                            fileName, 
                            webUrl: data.webUrl, 
                            downloadUrl: data['@microsoft.graph.downloadUrl']
                        });
                    } else {
                        downloadSharedFile(driveId, itemId, fileName);
                    }
                } catch (error) {
                    console.error("âŒ PaylaÅŸÄ±lan dosya aÃ§ma hatasÄ±:", error);
                    alert("PaylaÅŸÄ±lan dosya aÃ§Ä±lamadÄ±: " + error.message + "\n\nBu dosya iÃ§in direkt SharePoint'ten eriÅŸmeyi deneyin.");
                }
            } else {
                console.error("âŒ Drive ID veya Item ID eksik:", {driveId, itemId});
                alert("Dosya bilgileri eksik. LÃ¼tfen tekrar deneyin.");
            }
        }

        async function downloadSharedFile(driveId, itemId, fileName) {
            if (!driveId || !itemId) {
                alert("Dosya bilgileri eksik. PaylaÅŸ butonuna tÄ±klayarak SharePoint'ten aÃ§abilirsiniz.");
                return;
            }
            
            try {
                console.log("ðŸ“¥ Ä°ndiriliyor: drives/" + driveId + "/items/" + itemId);
                const response = await fetch(`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${itemId}/content`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("âŒ Ä°ndirme hatasÄ±:", errorText);
                    throw new Error("HTTP " + response.status);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                console.log("âœ… PaylaÅŸÄ±lan dosya indirildi:", fileName);
            } catch (error) {
                console.error("âŒ PaylaÅŸÄ±lan dosya indirme hatasÄ±:", error);
                alert("Dosya indirilemedi: " + error.message + "\n\nLÃ¼tfen paylaÅŸ butonuna tÄ±klayarak SharePoint'ten aÃ§mayÄ± deneyin.");
                // OTURUMU KAPATMA!
            }
        }

        async function openFile(fileId, fileName) {
            if (DEMO_MODE) {
                alert(`Demo Mode: "${fileName}" dosyasÄ± aÃ§Ä±lÄ±yor...\n\nGerÃ§ek OneDrive entegrasyonunda bu dosya arayÃ¼z iÃ§inde Ã¶nizlenecektir.`);
                return;
            }
            
            try {
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fileId}`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (!response.ok) {
                    throw new Error("Dosya bilgisi alÄ±namadÄ±");
                }

                const data = await response.json();
                
                // Ã–nizleme iÃ§in downloadUrl kullan (CSP bypass iÃ§in)
                const downloadUrl = data['@microsoft.graph.downloadUrl'];
                
                if (downloadUrl) {
                    console.log("âœ… Dosya downloadUrl ile Ã¶nizleniyor");
                    openPreview(fileName, downloadUrl, {fileId, fileName, webUrl: data.webUrl, downloadUrl: downloadUrl});
                } else if (data.webUrl) {
                    console.log("âš ï¸ downloadUrl yok, webUrl kullanÄ±lÄ±yor");
                    openPreview(fileName, data.webUrl, {fileId, fileName, webUrl: data.webUrl});
                } else {
                    console.log("âŒ Ã–nizleme URL'si yok, indiriliyor");
                    downloadFile(fileId, fileName);
                }
            } catch (error) {
                console.error("Dosya aÃ§ma hatasÄ±:", error);
                alert("Dosya aÃ§Ä±lamadÄ±: " + error.message);
            }
        }

        async function deleteFile(fileId, fileName) {
            if (!confirm(`"${fileName}" dosyasÄ±nÄ± silmek istediÄŸinizden emin misiniz?`)) {
                return;
            }

            if (DEMO_MODE) {
                alert(`Demo Mode: "${fileName}" dosyasÄ± silindi (simÃ¼lasyon).`);
                return;
            }

            try {
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fileId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (!response.ok) {
                    throw new Error("Dosya silinemedi");
                }

                showSuccess("Dosya baÅŸarÄ±yla silindi: " + fileName);
                loadFiles(currentFolderId);
            } catch (error) {
                console.error("Dosya silme hatasÄ±:", error);
                showError("Dosya silinemedi: " + error.message);
            }
        }

        async function uploadFiles(files) {
            if (!files || files.length === 0) return;

            if (DEMO_MODE) {
                alert(`Demo Mode: ${files.length} dosya yÃ¼kleniyor...\n\nSeÃ§ilen dosyalar:\n${Array.from(files).map(f => '- ' + f.name).join('\n')}\n\nGerÃ§ek OneDrive entegrasyonunda bu dosyalar yÃ¼klenecektir.`);
                document.getElementById('fileUploadInput').value = '';
                return;
            }

            showLoading();

            try {
                for (let file of files) {
                    const endpoint = currentFolderId === "root"
                        ? `https://graph.microsoft.com/v1.0/me/drive/root:/${file.name}:/content`
                        : `https://graph.microsoft.com/v1.0/me/drive/items/${currentFolderId}:/${file.name}:/content`;

                    const response = await fetch(endpoint, {
                        method: 'PUT',
                        headers: {
                            'Authorization': 'Bearer ' + accessToken,
                            'Content-Type': file.type
                        },
                        body: file
                    });

                    if (!response.ok) {
                        throw new Error(`Dosya yÃ¼klenemedi: ${file.name}`);
                    }
                }

                showSuccess(`${files.length} dosya baÅŸarÄ±yla yÃ¼klendi`);
                loadFiles(currentFolderId);
            } catch (error) {
                console.error("Dosya yÃ¼kleme hatasÄ±:", error);
                showError("Dosya yÃ¼klenirken hata oluÅŸtu: " + error.message);
                showFilesArea();
            }

            document.getElementById('fileUploadInput').value = '';
        }

        async function createFolder() {
            const folderName = prompt('Yeni klasÃ¶r adÄ±:');
            if (!folderName) return;

            if (DEMO_MODE) {
                alert(`Demo Mode: "${folderName}" klasÃ¶rÃ¼ oluÅŸturuldu (simÃ¼lasyon).`);
                return;
            }

            try {
                const endpoint = currentFolderId === "root"
                    ? "https://graph.microsoft.com/v1.0/me/drive/root/children"
                    : `https://graph.microsoft.com/v1.0/me/drive/items/${currentFolderId}/children`;

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: folderName,
                        folder: {},
                        '@microsoft.graph.conflictBehavior': 'rename'
                    })
                });

                if (!response.ok) {
                    throw new Error("KlasÃ¶r oluÅŸturulamadÄ±");
                }

                showSuccess("KlasÃ¶r baÅŸarÄ±yla oluÅŸturuldu: " + folderName);
                loadFiles(currentFolderId);
            } catch (error) {
                console.error("KlasÃ¶r oluÅŸturma hatasÄ±:", error);
                showError("KlasÃ¶r oluÅŸturulamadÄ±: " + error.message);
            }
        }

        async function shareFile(fileId) {
            if (DEMO_MODE) {
                const demoLink = 'https://onedrive.live.com/demo-share-link';
                navigator.clipboard.writeText(demoLink).catch(() => {});
                alert(`Demo Mode: PaylaÅŸÄ±m Linki\n\n${demoLink}\n\n(SimÃ¼lasyon - GerÃ§ek link deÄŸildir)`);
                return;
            }
            
            try {
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/createLink`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'view',
                        scope: 'anonymous'
                    })
                });

                if (!response.ok) {
                    throw new Error("PaylaÅŸÄ±m linki oluÅŸturulamadÄ±");
                }

                const data = await response.json();
                const shareLink = data.link.webUrl;

                // Linki kopyala
                navigator.clipboard.writeText(shareLink);
                showSuccess("PaylaÅŸÄ±m linki panoya kopyalandÄ±!");
                
                // Link gÃ¶ster
                alert("PaylaÅŸÄ±m Linki:\n\n" + shareLink + "\n\nLink panoya kopyalandÄ±!");
            } catch (error) {
                console.error("PaylaÅŸÄ±m hatasÄ±:", error);
                showError("PaylaÅŸÄ±m linki oluÅŸturulamadÄ±: " + error.message);
            }
        }

        function downloadSelected() {
            alert("Birden fazla dosya indirme Ã¶zelliÄŸi yakÄ±nda eklenecek.");
        }

        function deleteSelected() {
            alert("Birden fazla dosya silme Ã¶zelliÄŸi yakÄ±nda eklenecek.");
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        function showLoginPrompt() {
            document.getElementById('loginPrompt').style.display = 'block';
            document.getElementById('loadingArea').style.display = 'none';
            document.getElementById('filesArea').style.display = 'none';
            document.getElementById('refreshBtn').style.display = 'none';
            document.getElementById('signOutBtn').style.display = 'none';
            stopAuditorSessionTimer(auditorUser);
        }

        function showLoading() {
            document.getElementById('loginPrompt').style.display = 'none';
            document.getElementById('loadingArea').style.display = 'block';
            document.getElementById('filesArea').style.display = 'none';
        }

        function showFilesArea() {
            document.getElementById('loginPrompt').style.display = 'none';
            document.getElementById('loadingArea').style.display = 'none';
            document.getElementById('filesArea').style.display = 'block';
            document.getElementById('refreshBtn').style.display = 'inline-block';
            document.getElementById('signOutBtn').style.display = 'inline-block';
        }

        function showError(message) {
            alert("HATA: " + message);
        }

        function showSuccess(message) {
            // Toast notification eklenebilir
            console.log("BaÅŸarÄ±lÄ±:", message);
        }

        // Dosya Ã–nizleme FonksiyonlarÄ±
        async function openPreview(fileName, fileUrl, downloadInfo) {
            currentPreviewUrl = fileUrl;
            currentPreviewFile = downloadInfo || {};
            
            const modal = document.getElementById('previewModal');
            const iframe = document.getElementById('previewIframe');
            const loading = document.getElementById('previewLoading');
            const fileNameElement = document.getElementById('previewFileName');
            const editBtn = document.getElementById('previewEditBtn');
            
            // Modal'Ä± gÃ¶ster
            modal.classList.add('active');
            fileNameElement.textContent = fileName;
            
            // Loading gÃ¶ster
            loading.style.display = 'block';
            iframe.style.display = 'none';
            
            // Dosya uzantÄ±sÄ±nÄ± kontrol et
            const ext = fileName.split('.').pop().toLowerCase();
            
            // Office dosyalarÄ± iÃ§in "DÃ¼zenle" butonunu gÃ¶ster
            const isOfficeFile = ['docx', 'doc', 'xlsx', 'xls', 'pptx', 'ppt'].includes(ext);
            if (isOfficeFile && downloadInfo && downloadInfo.webUrl) {
                editBtn.style.display = 'inline-block';
            } else {
                editBtn.style.display = 'none';
            }
            
            // PDF iÃ§in Ã¶zel iÅŸlem: Blob olarak indir ve gÃ¶ster (CSP bypass)
            if (ext === 'pdf') {
                try {
                    console.log("ðŸ“• PDF indiriliyor ve Ã¶nizleniyor:", fileUrl);
                    loading.innerHTML = `
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="sr-only">YÃ¼kleniyor...</span>
                        </div>
                        <p class="mt-3"><strong>PDF YÃ¼kleniyor...</strong></p>
                        <p class="text-muted">BÃ¼yÃ¼k dosyalar biraz zaman alabilir</p>
                    `;
                    
                    const response = await fetch(fileUrl);
                    if (!response.ok) throw new Error("PDF yÃ¼klenemedi");
                    
                    const blob = await response.blob();
                    const blobUrl = URL.createObjectURL(blob);
                    
                    console.log("âœ… PDF blob URL oluÅŸturuldu:", blobUrl);
                    iframe.src = blobUrl;
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    
                    // iframe yÃ¼klenme sÃ¼resi
                    setTimeout(() => {
                        loading.style.display = 'none';
                        iframe.style.display = 'block';
                    }, 500);
                } catch (error) {
                    console.error("PDF yÃ¼kleme hatasÄ±:", error);
                    loading.innerHTML = `
                        <i class="fas fa-file-pdf" style="font-size: 3rem; color: #dc3545;"></i>
                        <p class="mt-3"><strong>PDF Ã¶nizlemesi yÃ¼klenemedi</strong></p>
                        <p class="text-muted">${error.message}</p>
                        <button class="btn btn-success mt-3" onclick="downloadCurrentPreview()">
                            <i class="fas fa-download"></i> PDF'i Ä°ndir
                        </button>
                    `;
                }
                return;
            }
            
            // Office dosyalarÄ± iÃ§in Office Online Viewer (CSP bypass iÃ§in SharePoint URL kullanÄ±lmaz)
            if (['docx', 'doc', 'xlsx', 'xls', 'pptx', 'ppt'].includes(ext)) {
                // Daima downloadUrl kullan (SharePoint webUrl CSP hatasÄ± verir)
                const sourceUrl = downloadInfo && downloadInfo.downloadUrl ? downloadInfo.downloadUrl : fileUrl;
                const previewUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(sourceUrl)}&wdStartOn=1`;
                
                console.log("ðŸ“Š Office Online Viewer aÃ§Ä±lÄ±yor:", {
                    fileName: fileName,
                    sourceUrl: sourceUrl.substring(0, 80) + '...',
                    viewer: 'https://view.officeapps.live.com'
                });
                
                loading.innerHTML = `
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="sr-only">YÃ¼kleniyor...</span>
                    </div>
                    <p class="mt-3"><strong>${ext.toUpperCase()} DosyasÄ± YÃ¼kleniyor...</strong></p>
                    <p class="text-muted">Microsoft Office Online Viewer (Sadece GÃ¶rÃ¼ntÃ¼leme)</p>
                    <p class="text-warning" style="font-size: 0.85rem;"><i class="fas fa-info-circle"></i> DÃ¼zenlemek iÃ§in "DÃ¼zenle (SharePoint)" butonunu kullanÄ±n</p>
                `;
                
                // Office Online viewer kullan
                iframe.src = previewUrl;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                
                // YÃ¼kleme timeout (Office dosyalarÄ± yavaÅŸ yÃ¼klenebilir)
                const loadTimeout = setTimeout(() => {
                    if (loading.style.display !== 'none') {
                        loading.innerHTML = `
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                <span class="sr-only">YÃ¼kleniyor...</span>
                            </div>
                            <p class="mt-3"><strong>Dosya yÃ¼kleniyor...</strong></p>
                            <p class="text-muted">BÃ¼yÃ¼k Office dosyalarÄ± uzun sÃ¼rebilir</p>
                        `;
                    }
                }, 3000);
                
                iframe.onload = function() {
                    clearTimeout(loadTimeout);
                    setTimeout(() => {
                        loading.style.display = 'none';
                        iframe.style.display = 'block';
                    }, 500);
                };
                
                iframe.onerror = function() {
                    clearTimeout(loadTimeout);
                    loading.innerHTML = `
                        <i class="fas fa-file-alt" style="font-size: 3rem; color: #dc3545;"></i>
                        <p class="mt-3"><strong>Office dosyasÄ± yÃ¼klenemedi</strong></p>
                        <p class="text-muted">Dosya Ã¶nizlemesi baÅŸarÄ±sÄ±z oldu</p>
                        <div class="mt-3">
                            <button class="btn btn-success mr-2" onclick="downloadCurrentPreview()">
                                <i class="fas fa-download"></i> DosyayÄ± Ä°ndir
                            </button>
                            <button class="btn btn-primary" onclick="openCurrentPreviewNewTab()">
                                <i class="fas fa-external-link-alt"></i> SharePoint'te AÃ§
                            </button>
                        </div>
                    `;
                };
                
                return;
            }
            
            // Resimler iÃ§in direkt gÃ¶ster
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(ext)) {
                console.log("ðŸ–¼ï¸ Resim Ã¶nizleniyor:", fileUrl);
                iframe.src = fileUrl;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                
                iframe.onload = function() {
                    loading.style.display = 'none';
                    iframe.style.display = 'block';
                };
                
                return;
            }
            
            // DiÄŸer dosya tÃ¼rleri iÃ§in direkt deneme
            console.log("ðŸ“„ Dosya Ã¶nizleniyor:", fileUrl);
            iframe.src = fileUrl;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            
            iframe.onload = function() {
                loading.style.display = 'none';
                iframe.style.display = 'block';
            };
            
            iframe.onerror = function() {
                loading.innerHTML = `
                    <i class="fas fa-file" style="font-size: 3rem; color: #6c757d;"></i>
                    <p class="mt-3"><strong>Ã–nizleme desteklenmiyor</strong></p>
                    <p class="text-muted">Bu dosya tÃ¼rÃ¼ tarayÄ±cÄ±da aÃ§Ä±lamÄ±yor.</p>
                    <button class="btn btn-success mt-3" onclick="downloadCurrentPreview()">
                        <i class="fas fa-download"></i> DosyayÄ± Ä°ndir
                    </button>
                `;
            };
        }
        
        function closePreview() {
            const modal = document.getElementById('previewModal');
            const iframe = document.getElementById('previewIframe');
            
            modal.classList.remove('active');
            iframe.src = 'about:blank';
            currentPreviewUrl = '';
            currentPreviewFile = {};
        }
        
        function downloadCurrentPreview() {
            if (currentPreviewFile.driveId && currentPreviewFile.itemId) {
                downloadSharedFile(currentPreviewFile.driveId, currentPreviewFile.itemId, currentPreviewFile.fileName);
            } else if (currentPreviewFile.fileId) {
                downloadFile(currentPreviewFile.fileId, currentPreviewFile.fileName);
            } else if (currentPreviewUrl) {
                window.open(currentPreviewUrl, '_blank');
            }
        }
        
        function openCurrentPreviewNewTab() {
            if (currentPreviewFile.webUrl) {
                window.open(currentPreviewFile.webUrl, '_blank');
            } else if (currentPreviewUrl) {
                window.open(currentPreviewUrl, '_blank');
            }
        }
        
        function editCurrentFile() {
            // Office dosyalarÄ±nÄ± dÃ¼zenlemek iÃ§in SharePoint'te aÃ§
            if (currentPreviewFile.webUrl) {
                console.log("ðŸ“ Dosya dÃ¼zenleme iÃ§in SharePoint'te aÃ§Ä±lÄ±yor:", currentPreviewFile.webUrl);
                window.open(currentPreviewFile.webUrl, '_blank');
            } else {
                alert("DÃ¼zenleme linki bulunamadÄ±. LÃ¼tfen 'Yeni Sekmede AÃ§' butonunu kullanÄ±n.");
            }
        }
        
        // ESC tuÅŸu ile modal'Ä± kapat
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePreview();
            }
        });
    </script>
</body>
</html>
